---
title: "Reproducible Research: Peer Assessment 2, Impact of Weather on Health and Economy"
output: 
  html_document:
    keep_md: true
---

Reproducible Data Assignment 2, Impact of Weather on Health and Economy
==============================

The goal of this assignment is to explore the NOAA Storm Database and answer two questions about severe weather events:

1. Across the United States, which types of events (as indicated in the *evtype* variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

# Data Processing


## Load the data

Download the dataset and load it into a dataframe.

```{r}
library(plyr)
library(ggplot2)
url <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
destfile <- "stormdata.csv.bz2"
if (!file.exists(destfile)) {
        download.file(url = url, destfile = destfile, method = "curl")
}

data <- read.csv(destfile)

```

## Preprocess the data

Tidy the column names by making them lowercase. 

The "evtype" column has numerous issues:
1 Misspellings
2 Mix of lowercase and uppercase values
3 Mix of plural and singular names
4 Mix of specific events such as "hurricane <name>" mixed with event types

The following code corrects the issues with "evtype" values.

```{r}
tidyData <- data
colnames(tidyData) <- tolower(colnames(tidyData))

## evtype names are both UPPER and lowercase make them all lowercase for grouping
tidyData$evtype <- trimws(tolower(tidyData$evtype), c("both"))

## Some events are plural, convert plural to singular events
tidyData$evtype <- ifelse (grepl(".*s$", tidyData$evtype),
                             substr(tidyData$evtype, 1, nchar(tidyData$evtype) - 1), 
                             tidyData$evtype)

## Convert all versions of flood to flood
tidyData$evtype <- ifelse (grepl("flood", tidyData$evtype), 
                             "flood",
                             tidyData$evtype)

## Convert all versions of hurriance to huricane
tidyData$evtype <- ifelse (grepl("hurricane", tidyData$evtype), 
                             "hurricane", 
                             tidyData$evtype)

## Convert all versions of thunderstorm to thunderstorm
tidyData$evtype <- ifelse (grepl("thunder", tidyData$evtype), 
                             "thunderstorm", 
                             tidyData$evtype)

## Convert all versions of ic* to ice
tidyData$evtype <- ifelse (grepl("^ic", tidyData$evtype), 
                             "ice", 
                             tidyData$evtype)

## Convert all versions of wint* to winter weather
tidyData$evtype <- ifelse (grepl("^wint", tidyData$evtype), 
                             "winter weather", 
                             tidyData$evtype)

## Convert all versions of wint* to winter weather
tidyData$evtype <- ifelse (grepl("snow", tidyData$evtype), 
                             "snow", 
                             tidyData$evtype)
```
# Results

##Which types of events (as indicated in the *evtype* variable) are most harmful with respect to population health?

We have data which gives us counts for injuries and fatalities for each event type. We'll group by evtype across all observations and sum injuries and fatalities.

Next we'll create a new value which is the sum of injuries + fatalities for each evtype.
```{r}
## Subset of columns for mapping events to health
healthColumns <- c("evtype","fatalities", "injuries")
healthData <- tidyData[healthColumns]

healthSummary <- ddply(healthData, .(evtype), numcolwise(sum))
healthSummary$injury_death <- healthSummary$fatalities + healthSummary$injuries
healthSummary <- subset(healthSummary, healthSummary$injury_death > 0)
healthSummary <- healthSummary[order(healthSummary$injury_death,decreasing = T),]


```
### 97% of all injuries are caused by 20 event types. Let's focus on those top 20 events.
```{r}
## Get the top 20
top20 <- healthSummary[1:20,]
sum(top20$injury_death) / sum(healthSummary$injury_death) * 100
```
### Most fatalities and injuries are from Tornados

```{r}
top20$events <- factor(top20$evtype, levels=top20$evtype, ordered=TRUE)
g <- ggplot(top20, aes(x=as.factor(events),y=injury_death)) +
        labs(x = "Event Type") + 
        labs(y = "Fatalities and Injuries") +
        labs(title = "Fatalities and Injuries by Weather Event") +
        geom_bar(stat = "Identity") + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
```

# Calculate property damage

```{r}
propdmgexp <- c("", "K", "M", "B")
propmultiple <- c("1", "1000", "1000000", "1000000000")

multiples <- cbind(propdmgexp, propmultiple)
propertyData <- merge(tidyData, multiples, by="propdmgexp")
propertyData$propdmg_m <- propertyData$propdmg * 
        as.numeric(as.character(propertyData$propmultiple))

cropdmgexp <- c("", "K", "M", "B")
cropmultiple <- c("1", "1000", "1000000", "1000000000")

multiples <- cbind(cropdmgexp, cropmultiple)
propertyData <- merge(propertyData, multiples, by="cropdmgexp")
propertyData$cropdmg_m <- propertyData$cropdmg * 
        as.numeric(as.character(propertyData$cropmultiple))
propertyData$totaldmg <- propertyData$propdmg_m + propertyData$cropdmg_m

propertySummary <- ddply(propertyData, .(evtype), numcolwise(sum))
propertySummary <- propertySummary[order(propertySummary$totaldmg,decreasing = T),]
```
## 98% of all damage is done by the top 20 events, let's focus on those
```{r}
top20 <- propertySummary[1:20,]
sum(top20$totaldmg) / sum(propertySummary$totaldmg) * 100
top20$events <- factor(top20$evtype, levels=top20$evtype, ordered=TRUE)
g <- ggplot(top20, aes(x=as.factor(events),y=totaldmg/10^6)) +
        labs(x = "Event Type") + 
        labs(y = "Cost of damages (1M)") +
        labs(title = "Damage by Weather Event") +
        geom_bar(stat = "Identity") + 
        theme(axis.text.x = element_text(angle = 90, hjust = 1))
print(g)
```